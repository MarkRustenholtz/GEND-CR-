<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CR Gendarmerie</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body { font-family: Arial,sans-serif; margin:10px; max-width:900px; margin:auto; background:#fff; color:#222;}
  h1,h2 { text-align:center; }
  button { cursor:pointer; font-weight:bold; border:none; border-radius:6px; padding:6px 12px; font-size:1.1em; margin:4px 2px; min-width:36px; min-height:36px; user-select:none; transition: background-color 0.2s ease;}
  button.plusminus { width:48px; border-radius:10px; font-size:1.5em;}
  button.plusminus:hover { background-color:#ddd; }
  button.red { background-color:#d9534f; color:white; }
  button.red:hover { background-color:#c9302c; }
  button.blue { background-color:#3498db; color:white; }
  button.blue:hover { background-color:#217dbb; }
  button.green { background-color:#28a745; color:white; }
  button.green:hover { background-color:#1e7e34; }
  .flex-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px;}
  .vehicle-card { border:2px solid #3498db; border-radius:10px; padding:12px; margin-bottom:18px; background:#f9fafe;}
  .vehicle-card h3 { margin-top:0; color:#2c3e50; }
  .manual-input { width:80px; font-size:1em; padding:4px 6px; }
  textarea { width:100%; min-height:80px; font-family: monospace; font-size:1em; padding:8px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; resize:vertical; }
  #qrcode { text-align:center; margin-top:20px; }
</style>
</head>
<body>
<h1>CR Gendarmerie - Moyens / Personnes</h1>

<section style="text-align:center; margin-bottom:20px;">
  <label style="margin-right:10px;">
    Nigend :
    <input type="text" id="nigend" class="manual-input" placeholder="Entrez Nigend">
  </label>
  <button id="validerNigend" class="green">Valider Nigend</button>
  <button id="resetNigendBtn" class="red">Effacer Nigend</button>
</section>

<section id="vehiculesSection">
<!-- Carte Train -->
<div class="vehicle-card" id="trainCard">
  <h3>Train</h3>
  <div class="flex-row">
    <div>
      <button class="plusminus" data-type="train" data-field="vehicles" data-action="minus">-</button>
      <span id="trainVehiclesCount">0</span> véhicules
      <button class="plusminus" data-type="train" data-field="vehicles" data-action="plus">+</button>
    </div>
    <div>
      <button class="plusminus" data-type="train" data-field="cv" data-action="minus">-</button>
      <span id="trainCvCount">0</span> CV
      <button class="plusminus" data-type="train" data-field="cv" data-action="plus">+</button>
    </div>
    <div>
      <label>Ajouter CV manuellement:
        <input type="number" id="trainCvManual" class="manual-input" min="0" value="0" />
        <button id="trainCvAddManualBtn" class="blue">Ajouter</button>
      </label>
    </div>
    <div>
      <button class="plusminus" data-type="train" data-field="cf" data-action="minus">-</button>
      <span id="trainCfCount">0</span> CF
      <button class="plusminus" data-type="train" data-field="cf" data-action="plus">+</button>
    </div>
  </div>
</div>

<!-- Carte Bus -->
<div class="vehicle-card" id="busCard">
  <h3>Bus</h3>
  <div class="flex-row">
    <div>
      <button class="plusminus" data-type="bus" data-field="vehicles" data-action="minus">-</button>
      <span id="busVehiclesCount">0</span> véhicules
      <button class="plusminus" data-type="bus" data-field="vehicles" data-action="plus">+</button>
    </div>
    <div>
      <button class="plusminus" data-type="bus" data-field="cv" data-action="minus">-</button>
      <span id="busCvCount">0</span> CV
      <button class="plusminus" data-type="bus" data-field="cv" data-action="plus">+</button>
    </div>
    <div>
      <label>Ajouter CV manuellement:
        <input type="number" id="busCvManual" class="manual-input" min="0" value="0" />
        <button id="busCvAddManualBtn" class="blue">Ajouter</button>
      </label>
    </div>
    <div>
      <button class="plusminus" data-type="bus" data-field="cf" data-action="minus">-</button>
      <span id="busCfCount">0</span> CF
      <button class="plusminus" data-type="bus" data-field="cf" data-action="plus">+</button>
    </div>
  </div>
</div>

<!-- Carte VL -->
<div class="vehicle-card" id="vlCard">
  <h3>VL</h3>
  <div class="flex-row">
    <div>
      <button class="plusminus" data-type="vl" data-field="vehicles" data-action="minus">-</button>
      <span id="vlVehiclesCount">0</span> véhicules
      <button class="plusminus" data-type="vl" data-field="vehicles" data-action="plus">+</button>
    </div>
    <div>
      <button class="plusminus" data-type="vl" data-field="cv" data-action="minus">-</button>
      <span id="vlCvCount">0</span> CV
      <button class="plusminus" data-type="vl" data-field="cv" data-action="plus">+</button>
    </div>
    <div>
      <label>Ajouter CV manuellement:
        <input type="number" id="vlCvManual" class="manual-input" min="0" value="0" />
        <button id="vlCvAddManualBtn" class="blue">Ajouter</button>
      </label>
    </div>
    <div>
      <button class="plusminus" data-type="vl" data-field="cf" data-action="minus">-</button>
      <span id="vlCfCount">0</span> CF
      <button class="plusminus" data-type="vl" data-field="cf" data-action="plus">+</button>
    </div>
  </div>
</div>

<!-- Carte PL -->
<div class="vehicle-card" id="plCard">
  <h3>PL</h3>
  <div class="flex-row">
    <div>
      <button class="plusminus" data-type="pl" data-field="vehicles" data-action="minus">-</button>
      <span id="plVehiclesCount">0</span> véhicules
      <button class="plusminus" data-type="pl" data-field="vehicles" data-action="plus">+</button>
    </div>
    <div>
      <button class="plusminus" data-type="pl" data-field="cv" data-action="minus">-</button>
      <span id="plCvCount">0</span> CV
      <button class="plusminus" data-type="pl" data-field="cv" data-action="plus">+</button>
    </div>
    <div>
      <label>Ajouter CV manuellement:
        <input type="number" id="plCvManual" class="manual-input" min="0" value="0" />
        <button id="plCvAddManualBtn" class="blue">Ajouter</button>
      </label>
    </div>
    <div>
      <button class="plusminus" data-type="pl" data-field="cf" data-action="minus">-</button>
      <span id="plCfCount">0</span> CF
      <button class="plusminus" data-type="pl" data-field="cf" data-action="plus">+</button>
    </div>
  </div>
</div>

</section>

<hr/>

<section style="text-align:center; margin-bottom:20px;">
  <button id="generateBtn" class="blue">Générer compte rendu</button>
  <button id="transmettreBtn" class="green">TRANSMETTRE</button>
  <button id="resetBtn" class="red">Effacer les données sauvegardées</button>
</section>

<div id="qrcode"></div>

<section>
  <h2>Compte rendu généré :</h2>
  <textarea id="compteRendu" readonly rows="12" style="font-family:monospace; white-space:pre-wrap;"></textarea>
</section>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").then(
      () => console.log("✅ Service Worker enregistré"),
      err => console.error("❌ SW error :", err)
    );
  });
}

(() => {
  const state = { vehicules:{train:0,bus:0,vl:0,pl:0}, cv:{train:0,bus:0,vl:0,pl:0}, cf:{train:0,bus:0,vl:0,pl:0} };
  let saveTimeout=null, crGenere=false, nigendValide=false;

  function debounceSave(){ if(saveTimeout) clearTimeout(saveTimeout); saveTimeout=setTimeout(()=>localStorage.setItem('moyensData',JSON.stringify(state)),3000);}
  function updateUI(){ ['train','bus','vl','pl'].forEach(t=>{ document.getElementById(t+'VehiclesCount').textContent=state.vehicules[t]; document.getElementById(t+'CvCount').textContent=state.cv[t]; document.getElementById(t+'CfCount').textContent=state.cf[t]; }); }
  function changeCount(type,field,action){ if(field==='vehicles'){ if(action==='plus') state.vehicules[type]++; else if(state.vehicules[type]>0) state.vehicules[type]--; } if(field==='cv'){ if(action==='plus') state.cv[type]++; else if(state.cv[type]>0) state.cv[type]--; } if(field==='cf'){ if(action==='plus') state.cf[type]++; else if(state.cf[type]>0) state.cf[type]--; } updateUI(); debounceSave(); }
  function addManualCv(type){ const input=document.getElementById(type+'CvManual'); const val=parseInt(input.value); if(isNaN(val)||val<1) return alert('Veuillez saisir un nombre entier >0.'); state.cv[type]+=val; input.value=0; updateUI(); debounceSave(); }
  function generateCR(){ let cr=''; ['train','bus','vl','pl'].forEach(t=>{ cr+=`${t.charAt(0).toUpperCase()+t.slice(1)}: ${state.vehicules[t]} / ${state.cv[t]} CV / ${state.cf[t]} CF\n`; }); const totalVehicules=['train','bus','vl','pl'].reduce((a,t)=>a+state.vehicules[t],0); const totalPersonnes=['train','bus','vl','pl'].reduce((a,t)=>a+state.cv[t]+state.cf[t],0); cr+=`\nTOTAL MOYENS : ${totalVehicules}\nTOTAL PERSONNES : ${totalPersonnes}`; document.getElementById('compteRendu').value=cr; crGenere=true; }

  const savedData=localStorage.getItem('moyensData'); if(savedData) try{ Object.assign(state,JSON.parse(savedData)); }catch(e){}
  const savedNigend=localStorage.getItem('nigend'); if(savedNigend){ document.getElementById('nigend').value=savedNigend; document.getElementById('nigend').disabled=true; document.getElementById('validerNigend').disabled=true; nigendValide=true; }

  updateUI();

  document.querySelectorAll('button.plusminus').forEach(b=>b.addEventListener('click',()=>changeCount(b.dataset.type,b.dataset.field,b.dataset.action)));
  ['train','bus','vl','pl'].forEach(t=>document.getElementById(t+'CvAddManualBtn').addEventListener('click',()=>addManualCv(t)));
  document.getElementById('generateBtn').addEventListener('click',generateCR);

  document.getElementById('validerNigend').addEventListener('click',()=>{
    const n=document.getElementById('nigend').value.trim(); if(!n) return alert("Veuillez entrer votre Nigend"); nigendValide=true; document.getElementById('nigend').disabled=true; document.getElementById('validerNigend').disabled=true; localStorage.setItem('nigend',n); alert("Nigend validé : "+n);
  });

  document.getElementById('resetNigendBtn').addEventListener('click',()=>{
    if(confirm("Voulez-vous vraiment effacer le Nigend ?")){ localStorage.removeItem('nigend'); document.getElementById('nigend').value=''; document.getElementById('nigend').disabled=false; document.getElementById('validerNigend').disabled=false; nigendValide=false; alert("Nigend effacé."); }
  });

  document.getElementById('transmettreBtn').addEventListener('click',()=>{
    if(!crGenere) return alert("Vous devez générer le compte rendu avant de transmettre !");
    if(!nigendValide) return alert("Vous devez valider votre Nigend avant d'envoyer !");

    const nigend = document.getElementById('nigend').value;
    const cr = document.getElementById('compteRendu').value;

    // Contenu formaté du QR code
    const contenuQR = `NIGEND: ${nigend}\n\n${cr}`;

    // Nettoyer avant de régénérer
    document.getElementById("qrcode").innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
        text: contenuQR,
        width: 256,
        height: 256
   });
  });

  document.getElementById('resetBtn').addEventListener('click',()=>{
    if(confirm('Voulez-vous vraiment effacer toutes les données sauvegardées ?')){
      localStorage.removeItem('moyensData'); ['train','bus','vl','pl'].forEach(t=>{ state.vehicules[t]=0; state.cv[t]=0; state.cf[t]=0; });
      updateUI(); document.getElementById('compteRendu').value=''; document.getElementById('qrcode').innerHTML=''; crGenere=false;
    }
  });

})();
</script>
</body>
</html>
